---
layout: none
permalink: /search.json
---

{%- assign all_pages = site.pages | concat: site.posts -%}
{%- for coll in site.collections -%}
  {%- unless coll.label == "posts" -%}
    {%- assign all_pages = all_pages | concat: coll.docs -%}
  {%- endunless -%}
{%- endfor -%}

{%- assign all_tags = "" | split: "" -%}
{%- for page in all_pages -%}
  {%- if page.tags -%}
    {%- for tag in page.tags -%}
      {%- assign tag_down = tag | downcase -%}
      {%- unless all_tags contains tag_down -%}
        {%- assign all_tags = all_tags | push: tag_down -%}
      {%- endunless -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- assign all_tags = all_tags | sort -%}

{
{%- assign first_tag = true -%}
{%- for tag in all_tags -%}
  {%- if first_tag -%}
    {%- assign first_tag = false -%}
  {%- else -%}
    ,
  {%- endif -%}

  "{{ tag }}": [
    {%- assign first_page = true -%}
    {%- assign seen_urls = "" | split: "" -%}

    {%- assign tag_pages = "" | split: "" -%}
    {%- for page in all_pages -%}
      {%- if page.tags contains tag -%}
        {%- assign url = page.url | relative_url -%}
        {%- unless seen_urls contains url -%}
          {%- assign tag_pages = tag_pages | push: page -%}
          {%- assign seen_urls = seen_urls | push: url -%}
        {%- endunless -%}
      {%- endif -%}
    {%- endfor -%}

    {%- assign tag_pages = tag_pages | sort: "date" | reverse -%}

    {%- for page in tag_pages -%}
      {%- assign title = page.title | jsonify -%}
      {%- assign url_json = page.url | relative_url | jsonify -%}
      {%- assign date = page.date | date: "%Y-%m-%d" | jsonify -%}

      {%- if first_page -%}
        {%- assign first_page = false -%}
      {%- else -%}
        ,
      {%- endif -%}

      { "title": {{ title }}, "url": {{ url_json }}, "date": {{ date }} }
    {%- endfor -%}
  ]
{%- endfor -%}
}
