---
layout: none
permalink: /search.json
---

{%- comment -%}
dict[tag] = "||" separated list of JSON objects
tag_keys   = list of tag strings for sorting
{%- endcomment -%}

{%- assign dict = {} -%}
{%- assign tag_keys = "" | split: "" -%}

{%- for coll in site.collections -%}
  {%- for page in coll.docs -%}
    {%- if page.tags -%}

      {%- assign title = page.title | jsonify -%}
      {%- assign url = page.url | relative_url | jsonify -%}
      {%- assign date = page.date | date_to_xmlschema | jsonify -%}

      {%- assign temp = 
        '{"title":' | append: title |
        ', "url":'   | append: url |
        ', "date":'  | append: date |
        '}'
      -%}

      {%- for tag in page.tags -%}
        {%- assign key = tag | downcase -%}

        {%- if dict[key] -%}
          {%- assign updated = dict[key] | append: "||" | append: temp -%}
          {%- assign dict = dict | merge: {{ key }}: updated -%}
        {%- else -%}
          {%- assign dict = dict | merge: {{ key }}: temp -%}
          {%- assign tag_keys = tag_keys | push: key -%}
        {%- endif -%}

      {%- endfor -%}

    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}

{%- comment -%}
Sort tags alphabetically
{%- endcomment -%}
{%- assign tag_keys = tag_keys | sort -%}

{%- comment -%}
BEGIN JSON OUTPUT
{%- endcomment -%}

{
{%- assign first_tag = true -%}
{%- for tag in tag_keys -%}

  {%- assign raw = dict[tag] -%}
  {%- assign items = raw | split: "||" -%}

  {%- comment -%}
  Sort pages inside the tag by date (newest first)
  Liquid can sort JSON-like strings by a subfield:
  sort: "date" works *only if items are JSON objects*
  which they are.
  {%- endcomment -%}
  {%- assign items = items | sort: "date" | reverse -%}

  {%- if first_tag -%}
    {%- assign first_tag = false -%}
  {%- else -%}
    ,
  {%- endif -%}

  "{{ tag }}": [
    {%- for item in items -%}
      {{ item }}{%- unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ]

{%- endfor -%}
}
