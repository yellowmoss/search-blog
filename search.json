---
layout: none
permalink: /search.json
---

{%- assign tag_keys = "" | split: "" -%}

{%- comment -%}
Use capture to store JSON strings per tag
{%- endcomment -%}

{%- for coll in site.collections -%}
  {%- for page in coll.docs -%}
    {%- if page.tags -%}

      {%- assign title = page.title | jsonify -%}
      {%- assign url   = page.url | relative_url | jsonify -%}
      {%- assign date  = page.date | date_to_xmlschema | jsonify -%}

      {%- assign temp = '{"title":' | append: title |
                        ', "url":' | append: url |
                        ', "date":' | append: date |
                        '}' -%}

      {%- for tag in page.tags -%}
        {%- assign key = tag | downcase -%}

        {%- comment -%} Add tag to list if new {%- endcomment -%}
        {%- unless tag_keys contains key -%}
          {%- assign tag_keys = tag_keys | push: key -%}
        {%- endunless -%}

        {%- comment -%} Capture/accumulate temp JSON for each tag {%- endcomment -%}
        {%- capture tag_content -%}
          {{ site[key] | default: "" }}{% unless site[key] == "" %}||{% endunless %}{{ temp }}
        {%- endcapture -%}

        {%- assign site = site | merge: {{ key }}: tag_content -%}

      {%- endfor -%}

    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}

{%- assign tag_keys = tag_keys | sort -%}

{
{%- assign first_tag = true -%}

{%- for tag in tag_keys -%}
  {%- assign raw = site[tag] | default: "" -%}
  {%- assign items = raw | split: "||" -%}
  {%- assign items = items | sort: "date" | reverse -%}

  {%- if first_tag -%}
    {%- assign first_tag = false -%}
  {%- else -%}
    ,
  {%- endif -%}

  "{{ tag }}": [
    {%- for item in items -%}
      {{ item }}{%- unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ]
{%- endfor -%}
}
